name: CI

on:
  push:
    branches: [main]
  pull_request:

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

env:
  UV_CACHE_DIR: /tmp/.uv-cache

jobs:
  # -------------------------------------------------------------------
  # Lint: ruff check + format
  # -------------------------------------------------------------------
  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: astral-sh/setup-uv@v5
        with:
          version: "latest"
      - name: Restore uv cache
        uses: actions/cache@v4
        with:
          path: /tmp/.uv-cache
          key: uv-lint-${{ runner.os }}-${{ hashFiles('uv.lock') }}
          restore-keys: uv-lint-${{ runner.os }}-
      - run: uv sync --group dev
      - name: Ruff lint
        run: uv run ruff check src/ tests/
      - name: Ruff format check
        run: uv run ruff format --check src/ tests/

  # -------------------------------------------------------------------
  # Type check: mypy strict mode
  # -------------------------------------------------------------------
  typecheck:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: astral-sh/setup-uv@v5
        with:
          version: "latest"
      - name: Restore uv cache
        uses: actions/cache@v4
        with:
          path: /tmp/.uv-cache
          key: uv-typecheck-${{ runner.os }}-${{ hashFiles('uv.lock') }}
          restore-keys: uv-typecheck-${{ runner.os }}-
      - run: uv sync --group dev
      - name: Mypy
        run: uv run mypy src/

  # -------------------------------------------------------------------
  # Test matrix: unit + integration across Python 3.11, 3.12, 3.13
  # -------------------------------------------------------------------
  test:
    runs-on: ubuntu-latest
    needs: [lint, typecheck]
    strategy:
      fail-fast: false
      matrix:
        python-version: ["3.11", "3.12", "3.13"]
    name: test (py${{ matrix.python-version }})
    steps:
      - uses: actions/checkout@v4
      - uses: astral-sh/setup-uv@v5
        with:
          version: "latest"
      - name: Restore uv cache
        uses: actions/cache@v4
        with:
          path: /tmp/.uv-cache
          key: uv-test-${{ runner.os }}-py${{ matrix.python-version }}-${{ hashFiles('uv.lock') }}
          restore-keys: uv-test-${{ runner.os }}-py${{ matrix.python-version }}-
      - name: Install dependencies
        run: uv sync --python ${{ matrix.python-version }} --group dev --group test

      # Unit tests with coverage
      - name: Unit tests
        run: >
          uv run pytest tests/unit/
          -m "not slow"
          --cov=src/research_agent
          --cov-branch
          --cov-report=term-missing
          --cov-report=xml:coverage-unit.xml
          --junitxml=results-unit.xml

      # Integration tests with coverage (append to existing .coverage)
      - name: Integration tests
        run: >
          uv run pytest tests/integration/
          -m "not slow"
          --cov=src/research_agent
          --cov-branch
          --cov-append
          --cov-report=term-missing
          --cov-report=xml:coverage.xml
          --junitxml=results-integration.xml

      # Enforce minimum coverage threshold
      - name: Check coverage threshold (80%)
        run: uv run coverage report --fail-under=80

      - name: Upload coverage to Codecov
        if: matrix.python-version == '3.12' && always()
        uses: codecov/codecov-action@v4
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: ./coverage.xml
          flags: python${{ matrix.python-version }}

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-py${{ matrix.python-version }}
          path: |
            results-unit.xml
            results-integration.xml
            coverage.xml

  # -------------------------------------------------------------------
  # Final status gate for branch protection
  # -------------------------------------------------------------------
  ci-pass:
    if: always()
    needs: [lint, typecheck, test]
    runs-on: ubuntu-latest
    steps:
      - name: Verify all jobs passed
        run: |
          if [[ "${{ needs.lint.result }}" != "success" ]]; then
            echo "lint failed" && exit 1
          fi
          if [[ "${{ needs.typecheck.result }}" != "success" ]]; then
            echo "typecheck failed" && exit 1
          fi
          if [[ "${{ needs.test.result }}" != "success" ]]; then
            echo "test failed" && exit 1
          fi
          echo "All CI checks passed"
